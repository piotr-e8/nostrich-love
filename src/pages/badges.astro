---
import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import { BadgeDisplay } from '../components/gamification/BadgeDisplay';
import type { Badge } from '../components/gamification/types';

// Define all 8 badges
const allBadges: Badge[] = [
  {
    id: 'key-master',
    name: 'Key Master',
    description: 'Generated your first Nostr key pair and secured them properly',
    emoji: 'ğŸ”‘',
    category: 'beginner',
    rarity: 'common',
    requirement: 'Generate and save your keys',
  },
  {
    id: 'first-post',
    name: 'First Post',
    description: 'Made your first post on Nostr',
    emoji: 'ğŸ“',
    category: 'beginner',
    rarity: 'common',
    requirement: 'Publish your first note',
  },
  {
    id: 'zap-receiver',
    name: 'Zap Receiver',
    description: 'Received your first Lightning Network zap',
    emoji: 'âš¡',
    category: 'intermediate',
    rarity: 'rare',
    requirement: 'Receive a zap from another user',
  },
  {
    id: 'community-builder',
    name: 'Community Builder',
    description: 'Followed 10+ accounts and engaged with the community',
    emoji: 'ğŸ¤',
    category: 'intermediate',
    rarity: 'rare',
    requirement: 'Follow 10 accounts',
  },
  {
    id: 'knowledge-seeker',
    name: 'Knowledge Seeker',
    description: 'Completed 5 learning guides',
    emoji: 'ğŸ“š',
    category: 'intermediate',
    rarity: 'rare',
    requirement: 'Complete 5 guides',
  },
  {
    id: 'nostr-graduate',
    name: 'Nostr Graduate',
    description: 'Completed all beginner and intermediate guides',
    emoji: 'ğŸ“',
    category: 'advanced',
    rarity: 'epic',
    requirement: 'Complete all guides',
  },
  {
    id: 'security-conscious',
    name: 'Security Conscious',
    description: 'Backed up your keys and enabled enhanced security',
    emoji: 'ğŸ›¡ï¸',
    category: 'intermediate',
    rarity: 'rare',
    requirement: 'Backup your keys securely',
  },
  {
    id: 'relay-explorer',
    name: 'Relay Explorer',
    description: 'Connected to 5+ different relays',
    emoji: 'ğŸŒ',
    category: 'intermediate',
    rarity: 'rare',
    requirement: 'Connect to 5 relays',
  },
];
---

<Layout
  title="Your Badges - Nostr Beginner Guide"
  description="View and collect badges as you learn and explore Nostr. Each badge represents a milestone in your journey."
>
  <Header />

  <main id="main-content">
    <!-- Hero Section -->
    <section class="relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-br from-friendly-purple-100/50 via-transparent to-friendly-gold-100/30 dark:from-friendly-purple-900/30 dark:to-friendly-gold-900/20" />
      
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16 relative">
        <div class="text-center max-w-3xl mx-auto">
          <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold tracking-tight mb-6">
            <span class="bg-gradient-to-r from-friendly-purple-600 to-friendly-purple-400 bg-clip-text text-transparent">
              Your Badges
            </span>
          </h1>
          <p class="text-xl text-gray-600 dark:text-gray-400 mb-8">
            Collect badges as you explore Nostr. Each one represents a milestone in your decentralized journey.
          </p>
          
          <!-- Badge Progress Summary -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl border-2 border-friendly-purple-200 dark:border-friendly-purple-700 p-6 shadow-sm max-w-md mx-auto">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Collection Progress</span>
              <span id="collection-percentage" class="text-2xl font-bold text-friendly-purple-600">0%</span>
            </div>
            <div class="h-3 w-full bg-gray-200 rounded-full overflow-hidden">
              <div 
                id="collection-progress-bar"
                class="h-full bg-gradient-to-r from-friendly-purple-500 to-friendly-gold-400 rounded-full transition-all duration-500"
                style="width: 0%"
              />
            </div>
            <p id="collection-text" class="text-sm text-gray-500 dark:text-gray-400 mt-2">
              0 of 8 badges earned
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Badge Grid Section -->
    <section class="py-12">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-5xl mx-auto">
          <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-gradient-to-br from-friendly-purple to-friendly-gold rounded-xl">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
              </div>
              <div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">All Badges</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400">Click on unlocked badges to see details</p>
              </div>
            </div>
          </div>

          <!-- Badge Grid Container - populated by client-side script -->
          <div id="badge-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 sm:gap-6">
            {allBadges.map((badge) => (
              <div
                class="badge-card group relative aspect-square rounded-2xl border-2 transition-all duration-300 overflow-hidden flex flex-col items-center justify-center p-3 cursor-pointer bg-gray-100 dark:bg-gray-900 border-gray-200 dark:border-gray-700 grayscale opacity-60"
                data-badge-id={badge.id}
                data-badge-name={badge.name}
                data-badge-description={badge.description}
                data-badge-emoji={badge.emoji}
                data-badge-rarity={badge.rarity}
                data-badge-category={badge.category}
                data-badge-requirement={badge.requirement}
              >
                <!-- Lock Icon -->
                <div class="absolute top-2 right-2 lock-icon">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>

                <!-- Emoji -->
                <div class="text-4xl mb-2 transition-transform duration-300 group-hover:scale-110">
                  {badge.emoji}
                </div>

                <!-- Name -->
                <p class="text-xs font-semibold text-center line-clamp-2 text-gray-500 dark:text-gray-500">
                  {badge.name}
                </p>

                <!-- Rarity Label -->
                <span class="text-[10px] uppercase tracking-wider mt-1 text-gray-400 rarity-label hidden">
                  {badge.rarity}
                </span>

                <!-- Hover Tooltip -->
                <div class="badge-tooltip absolute z-30 left-1/2 -translate-x-1/2 bottom-full mb-2 w-48 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                  <div class="bg-gray-900 dark:bg-gray-800 text-white text-xs rounded-xl p-3 shadow-xl border border-gray-700">
                    <p class="font-semibold mb-1">{badge.name}</p>
                    <p class="text-gray-300 mb-2">{badge.description}</p>
                    <p class="text-friendly-gold text-[10px] requirement-text">
                      ğŸ”’ {badge.requirement}
                    </p>
                    <div class="absolute top-full left-1/2 -translate-x-1/2 -mt-1">
                      <div class="w-2 h-2 bg-gray-900 dark:bg-gray-800 rotate-45 border-r border-b border-gray-700" />
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>

          <!-- Legend -->
          <div class="mt-8 flex flex-wrap items-center justify-center gap-6 text-sm text-gray-500 dark:text-gray-400">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded-full bg-green-500"></div>
              <span>Unlocked</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded-full bg-gray-300 dark:bg-gray-600"></div>
              <span>Locked</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <span>Hover for details</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Badge Details Modal -->
    <div id="badge-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
      <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-8 max-w-md w-full shadow-2xl transform scale-95 opacity-0 transition-all duration-300" id="badge-modal-content">
        <div class="text-center">
          <div id="modal-emoji" class="text-6xl mb-4"></div>
          <h3 id="modal-title" class="text-2xl font-bold text-gray-900 dark:text-white mb-2"></h3>
          <p id="modal-description" class="text-gray-600 dark:text-gray-400 mb-4"></p>
          <div id="modal-meta" class="flex items-center justify-center gap-4 text-sm mb-6">
            <span id="modal-rarity" class="px-3 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400"></span>
            <span id="modal-category" class="px-3 py-1 rounded-full bg-friendly-purple-100 dark:bg-friendly-purple-900/30 text-friendly-purple-700 dark:text-friendly-purple-400"></span>
          </div>
          <div id="modal-earned" class="hidden mb-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-xl">
            <p class="text-green-700 dark:text-green-400 font-semibold">âœ“ Earned</p>
            <p id="modal-earned-date" class="text-sm text-green-600 dark:text-green-500"></p>
          </div>
          <div id="modal-locked" class="mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
            <p class="text-gray-500 dark:text-gray-400 text-sm">
              <span class="font-semibold">How to unlock:</span>
              <span id="modal-requirement"></span>
            </p>
          </div>
          <button
            id="modal-close"
            class="w-full px-6 py-3 bg-friendly-purple-600 hover:bg-friendly-purple-700 text-white font-semibold rounded-xl transition-colors"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- CTA Section -->
    <section class="py-16 bg-gradient-to-br from-friendly-purple-100 via-white to-friendly-gold-50 dark:from-friendly-purple-900/30 dark:via-gray-900 dark:to-friendly-gold-900/20">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
          Want to earn more badges?
        </h2>
        <p class="text-xl text-gray-600 dark:text-gray-400 mb-8 max-w-2xl mx-auto">
          Continue exploring Nostr guides, connect with the community, and unlock all achievements!
        </p>
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
          <a
            href="/guides"
            class="inline-flex items-center justify-center px-8 py-4 text-base font-semibold text-white bg-friendly-purple-600 hover:bg-friendly-purple-700 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl hover:-translate-y-0.5"
          >
            Start Learning
            <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
          <a
            href="/progress"
            class="inline-flex items-center justify-center px-8 py-4 text-base font-semibold text-friendly-purple-700 dark:text-friendly-purple-400 bg-white dark:bg-gray-800 border-2 border-friendly-purple-200 dark:border-friendly-purple-700 hover:border-friendly-purple-400 dark:hover:border-friendly-purple-500 rounded-xl transition-all duration-200"
          >
            View Progress
            <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </a>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  const GAMIFICATION_KEY = 'nostrich-gamification-v1';

  // Badge metadata
  const badgeMetadata: Record<string, { name: string; description: string; emoji: string; rarity: string; category: string; requirement: string }> = {
    'key-master': { name: 'Key Master', description: 'Generated your first Nostr key pair and secured them properly', emoji: 'ğŸ”‘', rarity: 'common', category: 'beginner', requirement: 'Generate and save your keys' },
    'first-post': { name: 'First Post', description: 'Made your first post on Nostr', emoji: 'ğŸ“', rarity: 'common', category: 'beginner', requirement: 'Publish your first note' },
    'zap-receiver': { name: 'Zap Receiver', description: 'Received your first Lightning Network zap', emoji: 'âš¡', rarity: 'rare', category: 'intermediate', requirement: 'Receive a zap from another user' },
    'community-builder': { name: 'Community Builder', description: 'Followed 10+ accounts and engaged with the community', emoji: 'ğŸ¤', rarity: 'rare', category: 'intermediate', requirement: 'Follow 10 accounts' },
    'knowledge-seeker': { name: 'Knowledge Seeker', description: 'Completed 5 learning guides', emoji: 'ğŸ“š', rarity: 'rare', category: 'intermediate', requirement: 'Complete 5 guides' },
    'nostr-graduate': { name: 'Nostr Graduate', description: 'Completed all beginner and intermediate guides', emoji: 'ğŸ“', rarity: 'epic', category: 'advanced', requirement: 'Complete all guides' },
    'security-conscious': { name: 'Security Conscious', description: 'Backed up your keys and enabled enhanced security', emoji: 'ğŸ›¡ï¸', rarity: 'rare', category: 'intermediate', requirement: 'Backup your keys securely' },
    'relay-explorer': { name: 'Relay Explorer', description: 'Connected to 5+ different relays', emoji: 'ğŸŒ', rarity: 'rare', category: 'intermediate', requirement: 'Connect to 5 relays' },
  };

  // Rarity styles
  const rarityStyles: Record<string, { border: string; glow: string; text: string }> = {
    common: {
      border: 'border-gray-200 dark:border-gray-600',
      glow: '',
      text: 'text-gray-600 dark:text-gray-400',
    },
    rare: {
      border: 'border-blue-300 dark:border-blue-600',
      glow: 'shadow-blue-500/20',
      text: 'text-blue-600 dark:text-blue-400',
    },
    epic: {
      border: 'border-purple-300 dark:border-purple-600',
      glow: 'shadow-purple-500/30',
      text: 'text-purple-600 dark:text-purple-400',
    },
    legendary: {
      border: 'border-amber-300 dark:border-amber-600',
      glow: 'shadow-amber-500/40',
      text: 'text-amber-600 dark:text-amber-400',
    },
  };

  // Category colors
  const categoryColors: Record<string, string> = {
    beginner: 'from-green-400 to-emerald-500',
    intermediate: 'from-blue-400 to-indigo-500',
    advanced: 'from-purple-400 to-violet-500',
    special: 'from-amber-400 to-orange-500',
  };

  // Get gamification data
  function getGamificationData() {
    try {
      const stored = localStorage.getItem(GAMIFICATION_KEY);
      if (stored) {
        return JSON.parse(stored);
      }
    } catch (e) {
      console.error('Error reading gamification data:', e);
    }
    return null;
  }

  // Update badge grid
  function updateBadgeGrid() {
    const data = getGamificationData();
    const unlockedBadges = data?.badges || {};
    const badgeCards = document.querySelectorAll('.badge-card');
    
    let unlockedCount = 0;

    badgeCards.forEach((card) => {
      const badgeId = card.getAttribute('data-badge-id');
      if (!badgeId) return;

      const isUnlocked = unlockedBadges[badgeId]?.unlockedAt != null;
      const badgeInfo = badgeMetadata[badgeId];
      
      if (isUnlocked) {
        unlockedCount++;
        const rarityStyle = rarityStyles[badgeInfo.rarity];
        
        // Remove locked styling
        card.classList.remove('bg-gray-100', 'dark:bg-gray-900', 'border-gray-200', 'dark:border-gray-700', 'grayscale', 'opacity-60', 'cursor-not-allowed');
        
        // Add unlocked styling
        card.classList.add('bg-white', 'dark:bg-gray-800', rarityStyle.border, 'cursor-pointer', 'hover:scale-105', 'hover:shadow-lg');
        if (rarityStyle.glow) {
          card.classList.add(rarityStyle.glow);
        }

        // Hide lock icon
        const lockIcon = card.querySelector('.lock-icon');
        if (lockIcon) {
          lockIcon.classList.add('hidden');
        }

        // Show rarity label
        const rarityLabel = card.querySelector('.rarity-label');
        if (rarityLabel) {
          rarityLabel.classList.remove('hidden');
          rarityLabel.classList.add(rarityStyle.text);
        }

        // Update tooltip requirement text to show earned
        const requirementText = card.querySelector('.requirement-text');
        if (requirementText) {
          requirementText.textContent = 'âœ“ Earned';
          requirementText.classList.remove('text-friendly-gold');
          requirementText.classList.add('text-green-400');
        }

        // Add category indicator dot
        if (!card.querySelector('.category-dot')) {
          const dot = document.createElement('div');
          dot.className = `category-dot absolute top-2 left-2 w-2 h-2 rounded-full bg-gradient-to-r ${categoryColors[badgeInfo.category]}`;
          card.appendChild(dot);
        }

        // Add click handler for modal
        card.addEventListener('click', () => openBadgeModal(badgeId, true));
      } else {
        // Locked badge - add click handler to show requirement
        card.addEventListener('click', () => openBadgeModal(badgeId, false));
      }
    });

    // Update summary
    updateSummary(unlockedCount);
  }

  // Update summary section
  function updateSummary(unlockedCount: number) {
    const totalBadges = Object.keys(badgeMetadata).length;
    const percentage = Math.round((unlockedCount / totalBadges) * 100);

    const percentageEl = document.getElementById('collection-percentage');
    const progressBarEl = document.getElementById('collection-progress-bar');
    const textEl = document.getElementById('collection-text');

    if (percentageEl) {
      percentageEl.textContent = `${percentage}%`;
    }

    if (progressBarEl) {
      progressBarEl.style.width = `${percentage}%`;
    }

    if (textEl) {
      textEl.textContent = `${unlockedCount} of ${totalBadges} badges earned`;
    }
  }

  // Modal functions
  let currentModalBadgeId: string | null = null;

  function openBadgeModal(badgeId: string, isUnlocked: boolean) {
    const badge = badgeMetadata[badgeId];
    if (!badge) return;

    currentModalBadgeId = badgeId;
    const data = getGamificationData();
    const unlockedAt = data?.badges?.[badgeId]?.unlockedAt;

    // Update modal content
    const emojiEl = document.getElementById('modal-emoji');
    const titleEl = document.getElementById('modal-title');
    const descEl = document.getElementById('modal-description');
    const rarityEl = document.getElementById('modal-rarity');
    const categoryEl = document.getElementById('modal-category');
    const earnedEl = document.getElementById('modal-earned');
    const earnedDateEl = document.getElementById('modal-earned-date');
    const lockedEl = document.getElementById('modal-locked');
    const requirementEl = document.getElementById('modal-requirement');

    if (emojiEl) emojiEl.textContent = badge.emoji;
    if (titleEl) titleEl.textContent = badge.name;
    if (descEl) descEl.textContent = badge.description;
    if (rarityEl) {
      rarityEl.textContent = badge.rarity;
      rarityEl.className = `px-3 py-1 rounded-full text-xs uppercase tracking-wider ${rarityStyles[badge.rarity].text} bg-gray-100 dark:bg-gray-700`;
    }
    if (categoryEl) {
      categoryEl.textContent = badge.category;
    }

    if (isUnlocked && earnedEl && earnedDateEl) {
      earnedEl.classList.remove('hidden');
      lockedEl?.classList.add('hidden');
      if (unlockedAt) {
        const date = new Date(unlockedAt);
        earnedDateEl.textContent = `Earned on ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
      } else {
        earnedDateEl.textContent = 'Earned recently';
      }
    } else {
      earnedEl?.classList.add('hidden');
      lockedEl?.classList.remove('hidden');
      if (requirementEl) {
        requirementEl.textContent = badge.requirement;
      }
    }

    // Show modal
    const modal = document.getElementById('badge-modal');
    const modalContent = document.getElementById('badge-modal-content');
    
    if (modal && modalContent) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);
    }
  }

  function closeBadgeModal() {
    const modal = document.getElementById('badge-modal');
    const modalContent = document.getElementById('badge-modal-content');
    
    if (modal && modalContent) {
      modalContent.classList.remove('scale-100', 'opacity-100');
      modalContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        currentModalBadgeId = null;
      }, 300);
    }
  }

  // Initialize page
  function init() {
    updateBadgeGrid();

    // Close modal handlers
    const closeBtn = document.getElementById('modal-close');
    const modal = document.getElementById('badge-modal');
    
    closeBtn?.addEventListener('click', closeBadgeModal);
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeBadgeModal();
      }
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && currentModalBadgeId) {
        closeBadgeModal();
      }
    });

    // Listen for storage changes
    window.addEventListener('storage', (e) => {
      if (e.key === GAMIFICATION_KEY) {
        updateBadgeGrid();
      }
    });
  }

  // Run initialization
  if (typeof window !== 'undefined') {
    init();
  }
</script>
