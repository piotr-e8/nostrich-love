---
import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import { SKILL_LEVELS } from '../data/learning-paths';

const totalGuides = 15; // Total number of guides across all levels
---

<Layout
  title="Your Progress - Nostr Beginner Guide"
  description="Track your learning progress through Beginner, Intermediate, and Advanced skill levels."
>
  <Header />

  <main id="main-content">
    <!-- Hero Section -->
    <section class="relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-br from-friendly-purple-100/50 via-transparent to-friendly-gold-100/30 dark:from-friendly-purple-900/30 dark:to-friendly-gold-900/20" />
      
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16 relative">
        <div class="text-center max-w-3xl mx-auto">
          <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold tracking-tight mb-6">
            <span class="bg-gradient-to-r from-friendly-purple-600 to-friendly-purple-400 bg-clip-text text-transparent">
              Your Progress
            </span>
          </h1>
          <p class="text-xl text-gray-600 dark:text-gray-400 mb-8">
            Master Nostr one level at a time. Complete guides to unlock new skills and advance through the ranks.
          </p>
        </div>
      </div>
    </section>

    <!-- Summary Cards -->
    <section class="py-8 bg-gray-50 dark:bg-gray-900/30 border-y border-gray-200 dark:border-gray-800">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
          <!-- Guides Completed Card -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl border-2 border-friendly-purple-200 dark:border-friendly-purple-700 p-6 shadow-sm">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-xl bg-friendly-purple-100 dark:bg-friendly-purple-900/30 flex items-center justify-center flex-shrink-0">
                <svg class="w-7 h-7 text-friendly-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Guides Completed</p>
                <p id="guides-completed-count" class="text-3xl font-bold text-gray-900 dark:text-white">0</p>
              </div>
            </div>
          </div>

          <!-- Current Level Card -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl border-2 border-friendly-gold-200 dark:border-friendly-gold-700 p-6 shadow-sm">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-xl bg-friendly-gold-100 dark:bg-friendly-gold-900/30 flex items-center justify-center flex-shrink-0">
                <span id="current-level-icon" class="text-3xl">ðŸŒ±</span>
              </div>
              <div class="min-w-0 flex-1">
                <p class="text-sm text-gray-500 dark:text-gray-400">Current Level</p>
                <p id="current-level-name" class="text-2xl font-bold text-gray-900 dark:text-white truncate">Beginner</p>
              </div>
            </div>
          </div>

          <!-- Overall Progress Card -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl border-2 border-green-200 dark:border-green-700 p-6 shadow-sm">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-xl bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0">
                <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Overall Progress</p>
                <p id="progress-percentage" class="text-3xl font-bold text-gray-900 dark:text-white">0%</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Skill Level Progression -->
    <section class="py-12">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8 text-center">Skill Progression</h2>
          
          <!-- Progress Path Visual -->
          <div class="relative mb-12">
            <div class="absolute left-1/2 transform -translate-x-1/2 w-1 h-full bg-gray-200 dark:bg-gray-700 hidden md:block"></div>
            
            <!-- Level Sections -->
            <div id="level-container" class="space-y-8">
              <!-- Beginner Level -->
              <section class="level-section relative" data-level="beginner" data-unlocked="true">
                <div class="bg-white dark:bg-gray-800 rounded-2xl border-2 border-green-200 dark:border-green-700 p-6 md:p-8 shadow-sm transition-all duration-300">
                  <!-- Level Header -->
                  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-4">
                      <div class="w-16 h-16 rounded-2xl bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0">
                        <span class="text-3xl">ðŸŒ±</span>
                      </div>
                      <div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Beginner</h3>
                        <p class="text-gray-600 dark:text-gray-400">Foundation of Nostr</p>
                      </div>
                    </div>
                    <span class="status-badge inline-flex items-center gap-2 px-4 py-2 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 font-semibold">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                      </svg>
                      Unlocked
                    </span>
                  </div>

                  <!-- Progress Bar -->
                  <div class="mb-6">
                    <div class="flex justify-between text-sm mb-2">
                      <span class="text-gray-600 dark:text-gray-400">Progress</span>
                      <span class="progress-text font-semibold text-gray-900 dark:text-white">0/6 guides</span>
                    </div>
                    <div class="h-4 w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                      <div class="progress-fill h-full bg-gradient-to-r from-green-400 to-green-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                  </div>

                  <!-- Unlock Requirements (shown if not unlocked) -->
                  <div class="unlock-requirements hidden mb-6 p-4 bg-gray-100 dark:bg-gray-700/50 rounded-xl">
                    <div class="flex items-start gap-3">
                      <svg class="w-5 h-5 text-gray-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                      </svg>
                      <div>
                        <p class="font-medium text-gray-900 dark:text-white">Unlock Requirements</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Complete 4 Beginner guides to unlock Intermediate</p>
                      </div>
                    </div>
                  </div>

                  <!-- Guide List -->
                  <div class="guide-list space-y-3">
                    <!-- Guides populated by JavaScript -->
                  </div>
                </div>
              </section>

              <!-- Intermediate Level -->
              <section class="level-section relative" data-level="intermediate" data-unlocked="false">
                <div class="bg-white dark:bg-gray-800 rounded-2xl border-2 border-friendly-purple-200 dark:border-friendly-purple-700 p-6 md:p-8 shadow-sm transition-all duration-300 locked">
                  <!-- Level Header -->
                  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-4">
                      <div class="w-16 h-16 rounded-2xl bg-friendly-purple-100 dark:bg-friendly-purple-900/30 flex items-center justify-center flex-shrink-0">
                        <span class="text-3xl">ðŸš€</span>
                      </div>
                      <div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Intermediate</h3>
                        <p class="text-gray-600 dark:text-gray-400">Level up your skills</p>
                      </div>
                    </div>
                    <span class="status-badge inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-semibold">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                      </svg>
                      Locked
                    </span>
                  </div>

                  <!-- Progress Bar -->
                  <div class="mb-6">
                    <div class="flex justify-between text-sm mb-2">
                      <span class="text-gray-600 dark:text-gray-400">Progress</span>
                      <span class="progress-text font-semibold text-gray-900 dark:text-white">0/6 guides</span>
                    </div>
                    <div class="h-4 w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                      <div class="progress-fill h-full bg-gradient-to-r from-friendly-purple-400 to-friendly-purple-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                  </div>

                  <!-- Unlock Requirements -->
                  <div class="unlock-requirements mb-6 p-4 bg-friendly-purple-50 dark:bg-friendly-purple-900/20 rounded-xl border border-friendly-purple-200 dark:border-friendly-purple-700">
                    <div class="flex items-start gap-3">
                      <svg class="w-5 h-5 text-friendly-purple-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <div>
                        <p class="font-medium text-friendly-purple-700 dark:text-friendly-purple-400">Unlock Requirements</p>
                        <p class="text-sm text-friendly-purple-600 dark:text-friendly-purple-300">Complete 4 more Beginner guides to unlock Intermediate</p>
                      </div>
                    </div>
                  </div>

                  <!-- Guide List -->
                  <div class="guide-list space-y-3">
                    <!-- Guides populated by JavaScript -->
                  </div>
                </div>
              </section>

              <!-- Advanced Level -->
              <section class="level-section relative" data-level="advanced" data-unlocked="false">
                <div class="bg-white dark:bg-gray-800 rounded-2xl border-2 border-friendly-gold-200 dark:border-friendly-gold-700 p-6 md:p-8 shadow-sm transition-all duration-300 locked">
                  <!-- Level Header -->
                  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-4">
                      <div class="w-16 h-16 rounded-2xl bg-friendly-gold-100 dark:bg-friendly-gold-900/30 flex items-center justify-center flex-shrink-0">
                        <span class="text-3xl">âš¡</span>
                      </div>
                      <div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Advanced</h3>
                        <p class="text-gray-600 dark:text-gray-400">Master the protocol</p>
                      </div>
                    </div>
                    <span class="status-badge inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-semibold">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                      </svg>
                      Locked
                    </span>
                  </div>

                  <!-- Progress Bar -->
                  <div class="mb-6">
                    <div class="flex justify-between text-sm mb-2">
                      <span class="text-gray-600 dark:text-gray-400">Progress</span>
                      <span class="progress-text font-semibold text-gray-900 dark:text-white">0/3 guides</span>
                    </div>
                    <div class="h-4 w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                      <div class="progress-fill h-full bg-gradient-to-r from-friendly-gold-400 to-friendly-gold-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                  </div>

                  <!-- Unlock Requirements -->
                  <div class="unlock-requirements mb-6 p-4 bg-friendly-gold-50 dark:bg-friendly-gold-900/20 rounded-xl border border-friendly-gold-200 dark:border-friendly-gold-700">
                    <div class="flex items-start gap-3">
                      <svg class="w-5 h-5 text-friendly-gold-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <div>
                        <p class="font-medium text-friendly-gold-700 dark:text-friendly-gold-400">Unlock Requirements</p>
                        <p class="text-sm text-friendly-gold-600 dark:text-friendly-gold-300">Complete 4 Intermediate guides to unlock Advanced</p>
                      </div>
                    </div>
                  </div>

                  <!-- Guide List -->
                  <div class="guide-list space-y-3">
                    <!-- Guides populated by JavaScript -->
                  </div>
                </div>
              </section>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Recent Activity Section -->
    <section class="py-12 bg-gray-50 dark:bg-gray-900/30">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl mx-auto">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Recent Activity</h2>
          
          <div id="recent-activity" class="space-y-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 text-center">
              <p class="text-gray-500 dark:text-gray-400">
                No activity yet. Start learning to see your progress here!
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="py-16 bg-gradient-to-br from-friendly-purple-100 via-white to-friendly-gold-50 dark:from-friendly-purple-900/30 dark:via-gray-900 dark:to-friendly-gold-900/20">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
          Keep leveling up!
        </h2>
        <p class="text-xl text-gray-600 dark:text-gray-400 mb-8 max-w-2xl mx-auto">
          Every guide completed brings you closer to unlocking new levels. Your Nostr mastery awaits!
        </p>
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
          <a
            href="/guides"
            class="inline-flex items-center justify-center px-8 py-4 text-base font-semibold text-white bg-friendly-purple-600 hover:bg-friendly-purple-700 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl hover:-translate-y-0.5"
          >
            Continue Learning
            <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
          <a
            href="/badges"
            class="inline-flex items-center justify-center px-8 py-4 text-base font-semibold text-friendly-purple-700 dark:text-friendly-purple-400 bg-white dark:bg-gray-800 border-2 border-friendly-purple-200 dark:border-friendly-purple-700 hover:border-friendly-purple-400 dark:hover:border-friendly-purple-500 rounded-xl transition-all duration-200"
          >
            View Your Badges
            <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
            </svg>
          </a>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<style>
  .level-section.locked .bg-white,
  .level-section.locked .bg-gray-800 {
    opacity: 0.7;
  }
  
  .level-section.locked .guide-list {
    filter: blur(2px);
    pointer-events: none;
  }
  
  .level-section.locked:hover .bg-white,
  .level-section.locked:hover .bg-gray-800 {
    opacity: 0.85;
  }
  
  .guide-item {
    transition: all 0.2s ease;
  }
  
  .guide-item:hover {
    transform: translateX(4px);
  }
  
  .guide-item.completed {
    opacity: 0.7;
  }
  
  @media (max-width: 768px) {
    .level-section {
      margin-bottom: 1rem;
    }
  }
</style>

<script>
  import { loadGamificationData, getUnlockedLevels, getCompletedInLevel, getLevelProgress } from '../utils/gamification';
  import { SKILL_LEVELS, getLevelLength } from '../data/learning-paths';

  const STORAGE_KEY = 'nostrich-gamification-v1';
  
  // Guide metadata for display
  const guideMetadata: Record<string, { title: string; description: string }> = {
    'what-is-nostr': { title: 'What is Nostr?', description: 'Learn the fundamentals' },
    'keys-and-security': { title: 'Keys & Security', description: 'Protect your identity' },
    'quickstart': { title: 'Quickstart', description: 'Get started in minutes' },
    'finding-community': { title: 'Finding Community', description: 'Connect with others' },
    'faq': { title: 'FAQ', description: 'Common questions answered' },
    'relays-demystified': { title: 'Relays Demystified', description: 'Understand the network' },
    'nip05-identity': { title: 'NIP-05 Identity', description: 'Get your verified handle' },
    'zaps-and-lightning': { title: 'Zaps & Lightning', description: 'Send and receive value' },
    'nostr-tools': { title: 'Essential Tools', description: 'Must-have utilities' },
    'troubleshooting': { title: 'Troubleshooting', description: 'Fix common issues' },
    'multi-client': { title: 'Using Multiple Clients', description: 'Advanced workflows' },
    'relay-guide': { title: 'Relay Guide', description: 'Set up your own relay' },
    'privacy-security': { title: 'Privacy & Security', description: 'Advanced protection' },
    'nip17-private-messages': { title: 'Private Messages', description: 'NIP-17 deep dive' },
    'protocol-comparison': { title: 'Protocol Comparison', description: 'Nostr vs alternatives' },
  };

  // Format date for recent activity
  function formatDate(dateString: string): string {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  // Get progress data
  function getProgressData() {
    try {
      const data = loadGamificationData();
      return {
        completedGuides: data.progress?.completedGuides || [],
        completedWithTimestamps: data.progress?.completedGuidesWithTimestamps || [],
        unlockedLevels: data.progress?.unlockedLevels || ['beginner'],
        completedByLevel: data.progress?.completedByLevel || {
          beginner: [],
          intermediate: [],
          advanced: []
        }
      };
    } catch (e) {
      console.error('Error reading progress data:', e);
      return {
        completedGuides: [],
        completedWithTimestamps: [],
        unlockedLevels: ['beginner'],
        completedByLevel: { beginner: [], intermediate: [], advanced: [] }
      };
    }
  }

  // Update summary cards
  function updateSummaryCards() {
    const { completedGuides, unlockedLevels, completedByLevel } = getProgressData();
    const totalGuides = 15;
    
    // Update guides completed count
    const guidesCountEl = document.getElementById('guides-completed-count');
    if (guidesCountEl) {
      guidesCountEl.textContent = completedGuides.length.toString();
    }
    
    // Update current level
    const levelOrder = ['beginner', 'intermediate', 'advanced'];
    const currentLevel = unlockedLevels[unlockedLevels.length - 1] || 'beginner';
    const levelIcons: Record<string, string> = {
      beginner: 'ðŸŒ±',
      intermediate: 'ðŸš€',
      advanced: 'âš¡'
    };
    const levelNames: Record<string, string> = {
      beginner: 'Beginner',
      intermediate: 'Intermediate',
      advanced: 'Advanced'
    };
    
    const levelIconEl = document.getElementById('current-level-icon');
    const levelNameEl = document.getElementById('current-level-name');
    if (levelIconEl) levelIconEl.textContent = levelIcons[currentLevel];
    if (levelNameEl) levelNameEl.textContent = levelNames[currentLevel];
    
    // Update percentage
    const percentageEl = document.getElementById('progress-percentage');
    if (percentageEl) {
      const percentage = totalGuides > 0 ? Math.round((completedGuides.length / totalGuides) * 100) : 0;
      percentageEl.textContent = `${percentage}%`;
    }
  }

  // Update level sections
  function updateLevelSections() {
    const { unlockedLevels, completedByLevel } = getProgressData();
    const levels: ('beginner' | 'intermediate' | 'advanced')[] = ['beginner', 'intermediate', 'advanced'];
    
    levels.forEach((level, index) => {
      const section = document.querySelector(`[data-level="${level}"]`) as HTMLElement;
      if (!section) return;
      
      const isUnlocked = unlockedLevels.includes(level);
      const completed = completedByLevel[level]?.length || 0;
      const total = getLevelLength(level);
      const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
      
      // Update unlock status
      section.setAttribute('data-unlocked', isUnlocked.toString());
      const card = section.querySelector('.bg-white, .bg-gray-800') as HTMLElement;
      const statusBadge = section.querySelector('.status-badge') as HTMLElement;
      
      if (isUnlocked) {
        section.classList.remove('locked');
        if (card) {
          card.classList.remove('locked');
          card.style.opacity = '1';
        }
        if (statusBadge) {
          statusBadge.className = 'status-badge inline-flex items-center gap-2 px-4 py-2 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 font-semibold';
          statusBadge.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Unlocked
          `;
        }
      } else {
        section.classList.add('locked');
        if (card) card.classList.add('locked');
        if (statusBadge) {
          statusBadge.className = 'status-badge inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-semibold';
          statusBadge.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            Locked
          `;
        }
      }
      
      // Update progress bar
      const progressText = section.querySelector('.progress-text') as HTMLElement;
      const progressFill = section.querySelector('.progress-fill') as HTMLElement;
      
      if (progressText) progressText.textContent = `${completed}/${total} guides`;
      if (progressFill) progressFill.style.width = `${percentage}%`;
      
      // Update unlock requirements
      const unlockReqs = section.querySelector('.unlock-requirements') as HTMLElement;
      if (unlockReqs) {
        if (isUnlocked) {
          unlockReqs.classList.add('hidden');
        } else {
          unlockReqs.classList.remove('hidden');
          const reqText = unlockReqs.querySelector('p:last-child') as HTMLElement;
          if (reqText && index > 0) {
            const prevLevel = levels[index - 1];
            const prevCompleted = completedByLevel[prevLevel]?.length || 0;
            const threshold = 4;
            const needed = Math.max(0, threshold - prevCompleted);
            if (needed > 0) {
              reqText.textContent = `Complete ${needed} more ${prevLevel.charAt(0).toUpperCase() + prevLevel.slice(1)} guide${needed > 1 ? 's' : ''} to unlock ${level.charAt(0).toUpperCase() + level.slice(1)}`;
            } else {
              reqText.textContent = `You're ready to unlock ${level.charAt(0).toUpperCase() + level.slice(1)}!`;
            }
          }
        }
      }
      
      // Update guide list
      const guideList = section.querySelector('.guide-list') as HTMLElement;
      if (guideList) {
        const guides = SKILL_LEVELS[level]?.sequence || [];
        guideList.innerHTML = guides.map((guideId, idx) => {
          const meta = guideMetadata[guideId] || { title: guideId, description: '' };
          const isCompleted = completedByLevel[level]?.includes(guideId);
          const position = idx + 1;
          
          return `
            <a href="/guides/${guideId}" 
               class="guide-item flex items-center gap-4 p-3 rounded-xl border ${isCompleted ? 'border-green-200 dark:border-green-700 bg-green-50 dark:bg-green-900/20 completed' : 'border-gray-200 dark:border-gray-700 hover:border-friendly-purple-300 dark:hover:border-friendly-purple-600'} transition-all cursor-pointer"
               data-guide="${guideId}"
            >
              <div class="w-8 h-8 rounded-lg ${isCompleted ? 'bg-green-100 dark:bg-green-900/30' : 'bg-gray-100 dark:bg-gray-700'} flex items-center justify-center flex-shrink-0">
                ${isCompleted 
                  ? `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>`
                  : `<span class="text-sm font-semibold ${isCompleted ? 'text-green-600' : 'text-gray-500 dark:text-gray-400'}">${position}</span>`
                }
              </div>
              <div class="flex-1 min-w-0">
                <p class="font-medium ${isCompleted ? 'text-gray-600 dark:text-gray-400 line-through' : 'text-gray-900 dark:text-white'} truncate">
                  ${meta.title}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
                  ${meta.description}
                </p>
              </div>
              ${isCompleted 
                ? `<span class="text-xs text-green-600 dark:text-green-400 font-medium flex-shrink-0">Completed</span>`
                : `<svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>`
              }
            </a>
          `;
        }).join('');
      }
    });
  }

  // Update recent activity
  function updateRecentActivity() {
    const { completedWithTimestamps } = getProgressData();
    const container = document.getElementById('recent-activity');
    
    if (!container) return;
    
    // Get completed guides with timestamps, sorted by completion date
    const completedGuides = completedWithTimestamps
      .map((guide: any) => ({
        ...guide,
        metadata: guideMetadata[guide.id] || { title: guide.id, description: '' },
      }))
      .sort((a: any, b: any) => new Date(b.completedAt).getTime() - new Date(a.completedAt).getTime())
      .slice(0, 5); // Show last 5
    
    if (completedGuides.length === 0) {
      container.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 text-center">
          <p class="text-gray-500 dark:text-gray-400">
            No activity yet. Start learning to see your progress here!
          </p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = completedGuides.map((guide: any) => `
      <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 flex items-center gap-4">
        <div class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center flex-shrink-0">
          <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-gray-900 dark:text-white truncate">
            ${guide.metadata.title}
          </p>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            ${guide.metadata.description}
          </p>
        </div>
        <span class="text-sm text-gray-400 dark:text-gray-500 flex-shrink-0">
          ${formatDate(guide.completedAt)}
        </span>
      </div>
    `).join('');
  }

  // Initialize page
  function init() {
    updateSummaryCards();
    updateLevelSections();
    updateRecentActivity();
    
    // Listen for storage changes
    window.addEventListener('storage', (e) => {
      if (e.key === STORAGE_KEY) {
        updateSummaryCards();
        updateLevelSections();
        updateRecentActivity();
      }
    });
    
    // Handle clicks on locked levels
    document.querySelectorAll('.level-section.locked').forEach(section => {
      section.addEventListener('click', (e) => {
        // Don't intercept if clicking on a guide link
        if ((e.target as HTMLElement).closest('a')) return;
        
        // Show unlock requirements
        const reqs = section.querySelector('.unlock-requirements');
        if (reqs) {
          reqs.scrollIntoView({ behavior: 'smooth', block: 'center' });
          reqs.classList.add('ring-2', 'ring-friendly-purple-400');
          setTimeout(() => {
            reqs.classList.remove('ring-2', 'ring-friendly-purple-400');
          }, 2000);
        }
      });
    });
  }

  // Run initialization
  if (typeof window !== 'undefined') {
    init();
  }
</script>
