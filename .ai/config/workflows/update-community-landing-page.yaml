# Workflow: Update Community Landing Page
# Updates existing community landing pages with real accounts from follow-pack

workflow:
  id: update-community-landing-page
  name: Update Community Landing Page
  description: >
    Updates existing community landing pages by:
    - Replacing mock creator data with real accounts from follow-pack
    - Removing sample posts section
    - Ensuring category exists and has accounts
    - Updating navigation and exports
  version: 1.0.0

  inputs:
    - name: community_slug
      type: string
      required: true
      description: URL slug of the community page (e.g., "photographers", "musicians")
    
    - name: category_id
      type: string
      required: false
      description: Override follow-pack category ID (auto-detected from page if not provided)
    
    - name: add_accounts_if_empty
      type: boolean
      required: false
      default: true
      description: Run follow-pack workflow to add accounts if category has < 3 accounts
    
    - name: account_input_type
      type: string
      required: false
      default: "none"
      description: How to add accounts if needed - "none", "naddr", "npubs", or "search_follows"
    
    - name: account_input_data
      type: string
      required: false
      description: Input data for accounts (naddr, npubs, or source npub)
    
    - name: max_display_accounts
      type: number
      required: false
      default: 6
      description: Maximum number of accounts to display in featured section

  steps:
    - id: find_existing_page
      name: Find Existing Page
      agent: code-agent
      description: Locate the community landing page file
      inputs:
        slug: "{{workflow.inputs.community_slug}}"
        search_patterns:
          - "src/pages/nostr-for-{{workflow.inputs.community_slug}}.astro"
          - "src/pages/nostr-for-{{workflow.inputs.community_slug}}s.astro"
          - "src/pages/communities/{{workflow.inputs.community_slug}}.astro"
      outputs:
        - page_file_path
        - page_exists
        - page_content
      decision_gate: false

    - id: validate_page_exists
      name: Validate Page Exists
      agent: code-agent
      depends_on: [find_existing_page]
      description: Ensure the page was found
      inputs:
        page_exists: "{{steps.find_existing_page.outputs.page_exists}}"
        page_path: "{{steps.find_existing_page.outputs.page_file_path}}"
      outputs:
        - validation_status
      decision_gate: false

    - id: analyze_current_page
      name: Analyze Current Page
      agent: code-agent
      depends_on: [validate_page_exists]
      description: Extract current page structure, theme, benefits, etc.
      inputs:
        page_file: "{{steps.find_existing_page.outputs.page_file_path}}"
        page_content: "{{steps.find_existing_page.outputs.page_content}}"
      outputs:
        - current_title
        - current_description
        - current_icon
        - current_theme
        - current_benefits
        - current_category_id
        - has_sample_posts
        - has_mock_creators
      decision_gate: false

    - id: determine_category
      name: Determine Category ID
      agent: code-agent
      depends_on: [analyze_current_page]
      description: Determine which follow-pack category to use
      inputs:
        provided_category: "{{workflow.inputs.category_id}}"
        detected_category: "{{steps.analyze_current_page.outputs.current_category_id}}"
        page_slug: "{{workflow.inputs.community_slug}}"
        follow_pack_url: "{{steps.analyze_current_page.outputs.follow_pack_url}}"
      outputs:
        - category_id
      decision_gate: false

    - id: check_category_and_accounts
      name: Check Category and Accounts
      agent: code-agent
      depends_on: [determine_category]
      description: Check if category exists and has enough accounts
      inputs:
        category_id: "{{steps.determine_category.outputs.category_id}}"
        categories_file: "src/data/follow-pack/categories.ts"
        accounts_file: "src/data/follow-pack/accounts.ts"
        min_accounts: 3
      outputs:
        - category_exists
        - account_count
        - needs_accounts
      decision_gate: false

    - id: run_follow_pack_workflow
      name: Add Accounts if Needed
      agent: orchestrator-agent
      depends_on: [check_category_and_accounts]
      condition: "{{steps.check_category_and_accounts.outputs.needs_accounts}} == true && {{workflow.inputs.add_accounts_if_empty}} == true && {{workflow.inputs.account_input_type}} != 'none'"
      description: Run follow-pack workflow to populate category with accounts
      inputs:
        workflow_id: "add-follow-pack-accounts"
        input_type: "{{workflow.inputs.account_input_type}}"
        input_data: "{{workflow.inputs.account_input_data}}"
        category: "{{steps.determine_category.outputs.category_id}}"
      outputs:
        - accounts_added
      decision_gate: false

    - id: update_page_with_real_accounts
      name: Update Page with Real Accounts
      agent: code-agent
      depends_on: [check_category_and_accounts, run_follow_pack_workflow]
      description: Replace mock creators with real accounts, remove sample posts
      inputs:
        page_file: "{{steps.find_existing_page.outputs.page_file_path}}"
        category_id: "{{steps.determine_category.outputs.category_id}}"
        changes:
          - remove_mock_creators_array
          - add_featured_creators_component
          - remove_sample_posts_section
          - update_follow_pack_url
          - update_imports
        max_display: "{{workflow.inputs.max_display_accounts}}"
        featured_component: "FeaturedCreatorsFromPack"
      outputs:
        - page_updated
        - backup_created
      decision_gate: false

    - id: update_community_component
      name: Update CommunityLanding Component
      agent: code-agent
      depends_on: [update_page_with_real_accounts]
      description: Ensure CommunityLanding component supports real accounts
      inputs:
        component_file: "src/components/community/CommunityLanding.astro"
        check_features:
          - supports_real_accounts_prop
          - can_hide_sample_posts
          - imports_react_component
      outputs:
        - component_updated
      decision_gate: false

    - id: quality_check
      name: Quality Assurance
      agent: qa-agent
      depends_on: [update_page_with_real_accounts, update_community_component]
      description: Verify page updates are correct
      inputs:
        page_file: "{{steps.find_existing_page.outputs.page_file_path}}"
        checklist:
          - mock_creators_removed
          - real_accounts_component_added
          - sample_posts_removed
          - links_to_follow_pack_correct
          - category_exists
          - has_minimum_accounts
          - build_passes
      outputs:
        - qa_report
        - success_status
      decision_gate: true

    - id: apply_fixes
      name: Apply QA Fixes
      agent: code-agent
      depends_on: [quality_check]
      condition: "{{steps.quality_check.outputs.success_status}} == false"
      description: Apply fixes based on QA report
      inputs:
        page_file: "{{steps.find_existing_page.outputs.page_file_path}}"
        qa_report: "{{steps.quality_check.outputs.qa_report}}"
      outputs:
        - fixes_applied
      decision_gate: false

    - id: final_validation
      name: Final Validation
      agent: qa-agent
      depends_on: [apply_fixes]
      description: Final check after fixes
      inputs:
        page_file: "{{steps.find_existing_page.outputs.page_file_path}}"
      outputs:
        - final_status
      decision_gate: false

  outputs:
    - name: page_url
      source: find_existing_page.page_file_path
      description: Path to the updated landing page
    
    - name: category_id
      source: determine_category.category_id
      description: Follow-pack category ID used
    
    - name: accounts_added
      source: run_follow_pack_workflow.accounts_added
      description: Number of accounts added (if applicable)
    
    - name: sample_posts_removed
      source: update_page_with_real_accounts.page_updated
      description: Whether sample posts were removed
    
    - name: qa_status
      source: quality_check.success_status
      description: Final QA status
