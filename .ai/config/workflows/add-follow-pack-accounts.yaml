# Workflow: Add Accounts to Follow Pack
# Adds new accounts to the follow-pack curated list

workflow:
  id: add-follow-pack-accounts
  name: Add Accounts to Follow Pack
  description: >
    Adds new curated accounts to the follow-pack system by:
    - Processing naddr (kind 39089) follow packs
    - Processing individual npubs
    - Searching follows from source accounts
    - Fetching metadata and categorizing accounts
  version: 1.0.0

  inputs:
    - name: input_type
      type: string
      required: true
      description: Type of input - "naddr", "npubs", or "search_follows"
    
    - name: input_data
      type: string
      required: true
      description: >
        The input data based on type:
        - naddr: naddr string(s) separated by commas
        - npubs: npub string(s) separated by commas
        - search_follows: source npub to search
    
    - name: category
      type: string
      required: true
      description: Target category for the accounts (artists, musicians, parents, etc.)
    
    - name: threshold
      type: number
      required: false
      default: 60
      description: Minimum score threshold for search_follows (default 60)

  steps:
    - id: validate_input
      name: Validate Input
      agent: code-agent
      description: Validate input format and category exists
      inputs:
        input_type: "{{workflow.inputs.input_type}}"
        input_data: "{{workflow.inputs.input_data}}"
        category: "{{workflow.inputs.category}}"
        valid_categories: ["jumpstart", "artists", "photography", "musicians", "permaculture", "parents", "christians", "foodies", "mystics", "cool_people", "sovereign", "legit", "niche", "merchants", "doomscrolling", "books"]
      outputs:
        - validation_status
        - parsed_input
      decision_gate: false

    - id: process_naddr
      name: Process naddr Input
      agent: code-agent
      depends_on: [validate_input]
      condition: "{{workflow.inputs.input_type}} == 'naddr'"
      description: Decode naddr, fetch kind 39089 event, extract p-tags
      inputs:
        naddr_list: "{{steps.validate_input.outputs.parsed_input}}"
        category: "{{workflow.inputs.category}}"
        script: "scripts/process-naddr.cjs"
      outputs:
        - extracted_pubkeys
        - source_info
      decision_gate: false

    - id: process_npubs
      name: Process npub Input
      agent: code-agent
      depends_on: [validate_input]
      condition: "{{workflow.inputs.input_type}} == 'npubs'"
      description: Convert npubs to hex pubkeys
      inputs:
        npub_list: "{{steps.validate_input.outputs.parsed_input}}"
        category: "{{workflow.inputs.category}}"
        script: "scripts/process-npub.cjs"
      outputs:
        - extracted_pubkeys
      decision_gate: false

    - id: search_follows
      name: Search Source Follows
      agent: code-agent
      depends_on: [validate_input]
      condition: "{{workflow.inputs.input_type}} == 'search_follows'"
      description: Fetch contacts from source and score for category match
      inputs:
        source_npub: "{{workflow.inputs.input_data}}"
        category: "{{workflow.inputs.category}}"
        threshold: "{{workflow.inputs.threshold}}"
        script: "scripts/search-follows-v2.cjs"
      outputs:
        - scored_contacts
        - high_confidence_matches
      decision_gate: false

    - id: fetch_metadata
      name: Fetch Account Metadata
      agent: code-agent
      depends_on: [process_naddr, process_npubs, search_follows]
      description: Fetch kind 0 metadata for all pubkeys from relays
      inputs:
        pubkeys: "{{steps.process_naddr.outputs.extracted_pubkeys || steps.process_npubs.outputs.extracted_pubkeys || steps.search_follows.outputs.scored_contacts}}"
        relays: ["wss://relay.nostr.band", "wss://nos.lol", "wss://relay.damus.io"]
      outputs:
        - metadata_results
        - fetch_errors
      decision_gate: false

    - id: check_duplicates
      name: Check for Duplicates
      agent: code-agent
      depends_on: [fetch_metadata]
      description: Check against existing accounts in accounts.ts
      inputs:
        new_accounts: "{{steps.fetch_metadata.outputs.metadata_results}}"
        existing_accounts_file: "src/data/follow-pack/accounts.ts"
        check_both_formats: true
      outputs:
        - new_accounts_list
        - duplicates_list
        - existing_to_update
        - summary_stats
      decision_gate: false

    - id: categorize_accounts
      name: Categorize Accounts
      agent: code-agent
      depends_on: [check_duplicates]
      description: Assign categories and prepare final account objects
      inputs:
        accounts: "{{steps.check_duplicates.outputs.new_accounts_list}}"
        target_category: "{{workflow.inputs.category}}"
        existing_to_update: "{{steps.check_duplicates.outputs.existing_to_update}}"
        multi_category_support: true
      outputs:
        - categorized_accounts
        - accounts_to_update
        - final_summary
      decision_gate: false

    - id: present_summary
      name: Present Summary for Approval
      agent: orchestrator-agent
      depends_on: [categorize_accounts]
      description: Show summary and request confirmation
      inputs:
        summary: "{{steps.categorize_accounts.outputs.final_summary}}"
        new_accounts: "{{steps.categorize_accounts.outputs.categorized_accounts}}"
        accounts_to_update: "{{steps.categorize_accounts.outputs.accounts_to_update}}"
        duplicates: "{{steps.check_duplicates.outputs.duplicates_list}}"
        input_type: "{{workflow.inputs.input_type}}"
        category: "{{workflow.inputs.category}}"
      outputs:
        - presentation
      decision_gate: true

    - id: add_to_database
      name: Add to Follow Pack Database
      agent: code-agent
      depends_on: [present_summary]
      description: Write new accounts to accounts.ts and update categories
      inputs:
        new_accounts: "{{steps.categorize_accounts.outputs.categorized_accounts}}"
        accounts_to_update: "{{steps.categorize_accounts.outputs.accounts_to_update}}"
        accounts_file: "src/data/follow-pack/accounts.ts"
        update_timestamp: true
      outputs:
        - write_status
        - accounts_added_count
        - accounts_updated_count
      decision_gate: false

    - id: validate_integration
      name: Validate Integration
      agent: qa-agent
      depends_on: [add_to_database]
      description: Verify accounts were added correctly and build passes
      inputs:
        accounts_file: "src/data/follow-pack/accounts.ts"
        validation_checks:
          - typescript_valid
          - no_duplicate_npubs
          - categories_valid
          - build_passes
      outputs:
        - validation_report
        - success_status
      decision_gate: false

  outputs:
    - name: accounts_added
      source: add_to_database.accounts_added_count
      description: Number of new accounts added
    
    - name: accounts_updated
      source: add_to_database.accounts_updated_count
      description: Number of existing accounts updated with new category
    
    - name: duplicates_skipped
      source: check_duplicates.duplicates_list
      description: List of duplicate accounts that were skipped
    
    - name: validation_status
      source: validate_integration.success_status
      description: Final validation status
